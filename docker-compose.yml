version: '3.8'

services:
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    environment:
      TZ: "Asia/Shanghai"
      WATCHTOWER_NOTIFICATIONS: "shoutrrr"
      WATCHTOWER_NOTIFICATION_REPORT: "true"
      WATCHTOWER_NOTIFICATION_URL: "telegram://<你的BotToken>@telegram/?chats=<你的ChatID>"
      WATCHTOWER_NOTIFICATIONS_LEVEL: "info"
      WATCHTOWER_NOTIFICATION_TEMPLATE: |-
        {{- with .Report -}}
        📊 **容器更新报告**
        ---
        🔍 扫描总数：{{len .Scanned}}
        ✔️ 成功更新：{{len .Updated}}
        ⚠️ 跳过更新：{{len .Skipped}}
        ❌ 更新失败：{{len .Failed}}
        {{- if .Updated }}
        ✳️ **已更新容器：**
        {{- range .Updated }}
        - 容器名称：{{.Name}}
          镜像：{{.ImageName}}
          旧版本 ID：{{.CurrentImageID.ShortID}}
          新版本 ID：{{.LatestImageID.ShortID}}
        {{- end }}
        {{- end }}
        {{- if .Fresh }}
        🆕 **运行中容器：**
        {{- range .Fresh }}
        - 容器名称：{{.Name}}
          镜像：{{.ImageName}}
          状态：🟢 已启动
        {{- end }}
        {{- end }}
        {{- if .Skipped }}
        ⚠️ **跳过更新的容器：**
        {{- range .Skipped }}
        - 容器名称：{{.Name}}
          镜像：{{.ImageName}}
          状态：{{if eq .State "running"}}🟢 已启动{{else}}🛑 已停止{{end}}
          原因：{{.Error}}
        {{- end }}
        {{- end }}
        {{- if .Failed }}
        🛑 **更新失败的容器：**
        {{- range .Failed }}
        - 容器名称：{{.Name}}
          镜像：{{.ImageName}}
          状态：{{if eq .State "running"}}🟢 已启动{{else}}🛑 已停止{{end}}
          错误信息：{{.Error}}
        {{- end }}
        {{- end }}
        {{- end -}}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - --schedule
      - "0 0 1 * * *"
      - --cleanup
      - --warn-on-head-failure=never
      - --include-restarting
      - --notification-report
    restart: unless-stopped

  watchtower-bot:
    build: .
    container_name: watchtower-bot
    environment:
      - TELEGRAM_BOT_TOKEN=<你的BotToken>
      - ALLOWED_CHAT_ID=<你的ChatID>
      - DOCKER_SOCKET_PATH=/var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - watchtower
    restart: unless-stopped
