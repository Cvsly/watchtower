services:
  # ==============================
  # ğŸ³ Watchtower è‡ªåŠ¨æ›´æ–°æœåŠ¡
  # ==============================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      TZ: "Asia/Shanghai"
      WATCHTOWER_NOTIFICATIONS: "shoutrrr"
      WATCHTOWER_NOTIFICATION_REPORT: "true"
      WATCHTOWER_NOTIFICATIONS_LEVEL: ${WATCHTOWER_NOTIFICATION_LEVEL:-info}
      WATCHTOWER_NOTIFICATION_URL: "telegram://${BOT_TOKEN}@telegram/?chats=${ALLOWED_CHAT_ID}"
      WATCHTOWER_NOTIFICATION_TEMPLATE: |-
        {{- with .Report -}}
        ğŸ“Š **å®¹å™¨æ›´æ–°æŠ¥å‘Š**
        ---
        ğŸ” æ‰«ææ€»æ•°ï¼š{{len .Scanned}}
        âœ”ï¸ æˆåŠŸæ›´æ–°ï¼š{{len .Updated}}
        âš ï¸ è·³è¿‡æ›´æ–°ï¼š{{len .Skipped}}
        âŒ æ›´æ–°å¤±è´¥ï¼š{{len .Failed}}
        {{- if .Updated }}
        âœ³ï¸ **å·²æ›´æ–°å®¹å™¨ï¼š**
        {{- range .Updated }}
        - å®¹å™¨åç§°ï¼š{{.Name}}
          é•œåƒï¼š{{.ImageName}}
          æ—§ç‰ˆæœ¬ IDï¼š{{.CurrentImageID.ShortID}}
          æ–°ç‰ˆæœ¬ IDï¼š{{.LatestImageID.ShortID}}
        {{- end }}
        {{- end }}
        {{- if .Skipped }}
        âš ï¸ **è·³è¿‡æ›´æ–°çš„å®¹å™¨ï¼š**
        {{- range .Skipped }}
        - å®¹å™¨åç§°ï¼š{{.Name}}
          é•œåƒï¼š{{.ImageName}}
          çŠ¶æ€ï¼š{{if eq .State "running"}}ğŸŸ¢ å·²å¯åŠ¨{{else}}ğŸ›‘ å·²åœæ­¢{{end}}
          åŸå› ï¼š{{.Error}}
        {{- end }}
        {{- end }}
        {{- if .Failed }}
        ğŸ›‘ **æ›´æ–°å¤±è´¥çš„å®¹å™¨ï¼š**
        {{- range .Failed }}
        - å®¹å™¨åç§°ï¼š{{.Name}}
          é•œåƒï¼š{{.ImageName}}
          çŠ¶æ€ï¼š{{if eq .State "running"}}ğŸŸ¢ å·²å¯åŠ¨{{else}}ğŸ›‘ å·²åœæ­¢{{end}}
          é”™è¯¯ä¿¡æ¯ï¼š{{.Error}}
        {{- end }}
        {{- end }}

        ğŸ§¹ **ç³»ç»Ÿæ¸…ç†æŠ¥å‘Š**
        ---
        ğŸ—‘ï¸ åˆ é™¤åœæ­¢å®¹å™¨ï¼š{{or .Cleanup.RemovedContainers 0}} ä¸ª
        ğŸ§± åˆ é™¤æ— æ ‡ç­¾é•œåƒï¼š{{or .Cleanup.RemovedImages 0}} ä¸ª
        ğŸ’¾ åˆ é™¤æœªä½¿ç”¨å·ï¼š{{or .Cleanup.RemovedVolumes 0}} ä¸ª
        ğŸŒ åˆ é™¤æœªä½¿ç”¨ç½‘ç»œï¼š{{or .Cleanup.RemovedNetworks 0}} ä¸ª
        âœ… çŠ¶æ€ï¼š{{if .Cleanup.HasCleanup}}å·²æ¸…ç†{{else}}ç³»ç»ŸçŠ¶æ€è‰¯å¥½{{end}}
        {{- end -}}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - --schedule
      - ${WATCHTOWER_SCHEDULE}  # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å®šæ—¶è®¾ç½®
      - --cleanup
      - --include-restarting
      - --notification-report
      - --notifications-level=${WATCHTOWER_NOTIFICATION_LEVEL:-info}
    restart: unless-stopped

  # ==============================
  # ğŸ¤– Watchtower æ§åˆ¶æœºå™¨äºº
  # ==============================
  watchtower-bot:
    build: .
    container_name: watchtower-bot
    environment:
      - TELEGRAM_BOT_TOKEN=${BOT_TOKEN}
      - ALLOWED_CHAT_ID=${ALLOWED_CHAT_ID}
      - DOCKER_SOCKET_PATH=/var/run/docker.sock
      - WATCHTOWER_SCHEDULE=${WATCHTOWER_SCHEDULE}  # ä¼ é€’å®šæ—¶è®¾ç½®ç»™ Bot
      - WATCHTOWER_NOTIFICATION_LEVEL=${WATCHTOWER_NOTIFICATION_LEVEL:-info}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
